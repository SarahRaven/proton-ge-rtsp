From 5a290441a6958bc627705f5843146f3c646f7169 Mon Sep 17 00:00:00 2001
From: Bones <babblebones@protnmail.com>
Date: Tue, 12 Aug 2025 13:24:35 -0400
Subject: [PATCH] winegstreamer: Do not seek live sources.

---
 dlls/winegstreamer/gst_private.h  |  3 +-
 dlls/winegstreamer/main.c         | 16 +++++++--
 dlls/winegstreamer/media_source.c |  6 +++-
 dlls/winegstreamer/unixlib.h      | 12 ++++++-
 dlls/winegstreamer/wg_parser.c    | 56 +++++++++++++++++++++++++++++--
 5 files changed, 86 insertions(+), 7 deletions(-)

diff --git a/dlls/winegstreamer/gst_private.h b/dlls/winegstreamer/gst_private.h
index c64e9ca251d..ae86e7c8a73 100644
--- a/dlls/winegstreamer/gst_private.h
+++ b/dlls/winegstreamer/gst_private.h
@@ -80,10 +80,11 @@ void wg_parser_disconnect(wg_parser_t parser);
 
 bool wg_parser_get_next_read_offset(wg_parser_t parser, uint64_t *offset, uint32_t *size);
 void wg_parser_push_data(wg_parser_t parser, const void *data, uint32_t size);
-
 uint32_t wg_parser_get_stream_count(wg_parser_t parser);
 wg_parser_stream_t wg_parser_get_stream(wg_parser_t parser, uint32_t index);
 
+BOOL wg_parser_is_seekable(wg_parser_t parser);
+
 void wg_parser_stream_get_current_format(wg_parser_stream_t stream, struct wg_format *format);
 void wg_parser_stream_get_codec_format(wg_parser_stream_t stream, struct wg_format *format);
 void wg_parser_stream_enable(wg_parser_stream_t stream, const struct wg_format *format);
diff --git a/dlls/winegstreamer/main.c b/dlls/winegstreamer/main.c
index c1b7a7a7bda..83942f6cc7b 100644
--- a/dlls/winegstreamer/main.c
+++ b/dlls/winegstreamer/main.c
@@ -265,11 +265,23 @@ wg_parser_stream_t wg_parser_get_stream(wg_parser_t parser, uint32_t index)
     TRACE("parser %#I64x, index %u.\n", parser, index);
 
     WINE_UNIX_CALL(unix_wg_parser_get_stream, &params);
-
-    TRACE("Returning stream %#I64x.\n", params.stream);
     return params.stream;
 }
 
+BOOL wg_parser_is_seekable(wg_parser_t parser)
+{
+    struct wg_parser_is_seekable_params params =
+    {
+        .parser = parser,
+    };
+
+    TRACE("parser %#I64x.\n", parser);
+
+    WINE_UNIX_CALL(unix_wg_parser_is_seekable, &params);
+    return params.seekable;
+}
+
+static HRESULT wg_get_media_type_mf(enum unix_funcs unix_func, void *params,
 void wg_parser_stream_get_current_format(wg_parser_stream_t stream, struct wg_format *format)
 {
     struct wg_parser_stream_get_current_format_params params =
diff --git a/dlls/winegstreamer/media_source.c b/dlls/winegstreamer/media_source.c
index 0ce63cf720d..214a3056e3c 100644
--- a/dlls/winegstreamer/media_source.c
+++ b/dlls/winegstreamer/media_source.c
@@ -1523,7 +1523,11 @@ static HRESULT WINAPI media_source_GetCharacteristics(IMFMediaSource *iface, DWO
     if (source->state == SOURCE_SHUTDOWN)
         hr = MF_E_SHUTDOWN;
     else
-        *characteristics = MFMEDIASOURCE_CAN_SEEK | MFMEDIASOURCE_CAN_PAUSE;
+    {
+        *characteristics = MFMEDIASOURCE_CAN_PAUSE;
+        if (!source->wg_parser || wg_parser_is_seekable(source->wg_parser))
+            *characteristics |= MFMEDIASOURCE_CAN_SEEK;
+    }
 
     LeaveCriticalSection(&source->cs);
 
diff --git a/dlls/winegstreamer/unixlib.h b/dlls/winegstreamer/unixlib.h
index 7cb5855e509..ecbc55db320 100644
--- a/dlls/winegstreamer/unixlib.h
+++ b/dlls/winegstreamer/unixlib.h
@@ -257,10 +257,17 @@ struct wg_parser_get_stream_count_params
 struct wg_parser_get_stream_params
 {
     wg_parser_t parser;
-    UINT32 index;
+    uint32_t index;
     wg_parser_stream_t stream;
 };
 
+struct wg_parser_is_seekable_params
+{
+    wg_parser_t parser;
+    BOOL seekable;
+};
+
+
 struct wg_parser_stream_get_current_format_params
 {
     wg_parser_stream_t stream;
@@ -435,6 +442,9 @@ enum unix_funcs
     unix_wg_parser_get_stream_count,
     unix_wg_parser_get_stream,
 
+    unix_wg_parser_is_seekable,
+
+
     unix_wg_parser_stream_get_current_format,
     unix_wg_parser_stream_get_codec_format,
     unix_wg_parser_stream_enable,
diff --git a/dlls/winegstreamer/wg_parser.c b/dlls/winegstreamer/wg_parser.c
index 05c9e0dc3d1..013571e5865 100644
--- a/dlls/winegstreamer/wg_parser.c
+++ b/dlls/winegstreamer/wg_parser.c
@@ -108,6 +108,8 @@ struct wg_parser
     bool use_mediaconv;
     bool use_opengl;
     GstContext *context;
+
+    bool is_seekable;
 };
 static const unsigned int input_cache_chunk_size = 512 << 10;
 
@@ -172,6 +174,15 @@ static NTSTATUS wg_parser_get_stream(void *args)
     return S_OK;
 }
 
+static NTSTATUS wg_parser_is_seekable(void *args)
+{
+    struct wg_parser_is_seekable_params *params = args;
+    struct wg_parser *parser = get_parser(params->parser);
+
+    params->seekable = parser->is_seekable;
+    return S_OK;
+}
+
 static NTSTATUS wg_parser_get_next_read_offset(void *args)
 {
     struct wg_parser_get_next_read_offset_params *params = args;
@@ -540,6 +551,9 @@ static NTSTATUS wg_parser_stream_seek(void *args)
 
     stream = get_stream(params->stream);
 
+    if (!stream->parser->is_seekable)
+        return S_OK;
+
     if (start_flags & AM_SEEKING_SeekToKeyFrame)
         flags |= GST_SEEK_FLAG_KEY_UNIT;
     if (start_flags & AM_SEEKING_Segment)
@@ -1926,8 +1940,9 @@ static NTSTATUS wg_parser_connect(void *args)
     parser->start_offset = parser->next_offset = parser->stop_offset = 0;
     parser->next_pull_offset = 0;
     parser->error = false;
+    parser->is_seekable = true;
 
-    if (!decodebin_parser_init_gst(parser))
+    if (!parser->init_gst(parser))
         goto out;
 
     gst_element_set_base_time(parser->container, gst_clock_get_time(clock));
@@ -1946,6 +1961,11 @@ static NTSTATUS wg_parser_connect(void *args)
             GST_ERROR("Failed to play stream.");
         goto out;
     }
+    else if (ret == GST_STATE_CHANGE_NO_PREROLL && parser->uri)
+    {
+        GST_DEBUG("Stream does not preroll.");
+        parser->is_seekable = false;
+    }
 
     pthread_mutex_lock(&parser->mutex);
 
@@ -1967,6 +1987,24 @@ static NTSTATUS wg_parser_connect(void *args)
         goto out;
     }
 
+    if (parser->stream_count && parser->is_seekable)
+    {
+        GstQuery *query = gst_query_new_seeking(GST_FORMAT_TIME);
+        gboolean seekable = false;
+
+        if (query)
+        {
+            if (gst_pad_peer_query(parser->streams[0]->my_sink, query))
+                gst_query_parse_seeking(query, NULL, &seekable, NULL, NULL);
+            gst_query_unref(query);
+        }
+        if (!seekable)
+        {
+            GST_DEBUG("Stream is not seekable.");
+            parser->is_seekable = false;
+        }
+    }
+
     for (i = 0; i < parser->stream_count; ++i)
     {
         struct wg_parser_stream *stream = parser->streams[i];
@@ -2009,7 +2047,17 @@ static NTSTATUS wg_parser_connect(void *args)
             }
             if (gst_pad_peer_query_duration(stream->my_sink, GST_FORMAT_TIME, &duration))
             {
-                stream->duration = duration == -1 ? (uint64_t)-1 : duration / 100;
+                if (duration == -1)
+                {
+                    if (parser->uri)
+                    {
+                        GST_DEBUG("Stream has no duration.");
+                        parser->is_seekable = false;
+                    }
+                    stream->duration = (uint64_t)-1;
+                }
+                else
+                    stream->duration = duration / 100;
                 break;
             }
 
@@ -2254,6 +2302,8 @@ const unixlib_entry_t __wine_unix_call_funcs[] =
     X(wg_parser_get_stream_count),
     X(wg_parser_get_stream),
 
+    X(wg_parser_is_seekable),
+
     X(wg_parser_stream_get_current_format),
     X(wg_parser_stream_get_codec_format),
     X(wg_parser_stream_enable),
@@ -2651,6 +2701,8 @@ const unixlib_entry_t __wine_unix_call_wow64_funcs[] =
     X(wg_parser_get_stream_count),
     X(wg_parser_get_stream),
 
+    X(wg_parser_is_seekable),
+
     X64(wg_parser_stream_get_current_format),
     X64(wg_parser_stream_get_codec_format),
     X64(wg_parser_stream_enable),
-- 
2.50.1

