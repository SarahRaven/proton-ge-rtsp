From 1c98e38fc77124bd6926e1d4580959b13cfbf644 Mon Sep 17 00:00:00 2001
From: Bones <babblebones@protnmail.com>
Date: Tue, 12 Aug 2025 13:09:39 -0400
Subject: [PATCH] winegstreamer: Handle a duration of -1 correctly.

---
 dlls/winegstreamer/media_source.c | 7 +++++--
 dlls/winegstreamer/wg_parser.c    | 2 +-
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/dlls/winegstreamer/media_source.c b/dlls/winegstreamer/media_source.c
index 2c0068c823f..0ce63cf720d 100644
--- a/dlls/winegstreamer/media_source.c
+++ b/dlls/winegstreamer/media_source.c
@@ -1544,8 +1544,11 @@ static HRESULT WINAPI media_source_CreatePresentationDescriptor(IMFMediaSource *
         hr = MF_E_SHUTDOWN;
     else if (SUCCEEDED(hr = MFCreatePresentationDescriptor(source->stream_count, source->descriptors, descriptor)))
     {
-        if (FAILED(hr = IMFPresentationDescriptor_SetUINT64(*descriptor, &MF_PD_DURATION, source->duration)))
-            WARN("Failed to set presentation descriptor MF_PD_DURATION, hr %#lx\n", hr);
+        if (source->duration != (UINT64)-1)
+        {
+            if (FAILED(hr = IMFPresentationDescriptor_SetUINT64(*descriptor, &MF_PD_DURATION, source->duration)))
+                WARN("Failed to set presentation descriptor MF_PD_DURATION, hr %#lx\n", hr);
+        }
 
         for (i = 0; i < source->stream_count; ++i)
         {
diff --git a/dlls/winegstreamer/wg_parser.c b/dlls/winegstreamer/wg_parser.c
index 2668e48ae30..3477735c7e0 100644
--- a/dlls/winegstreamer/wg_parser.c
+++ b/dlls/winegstreamer/wg_parser.c
@@ -1908,7 +1908,7 @@ static NTSTATUS wg_parser_connect(void *args)
             }
             if (gst_pad_peer_query_duration(stream->my_sink, GST_FORMAT_TIME, &duration))
             {
-                stream->duration = duration / 100;
+                stream->duration = duration == -1 ? (uint64_t)-1 : duration / 100;
                 break;
             }
 
-- 
2.50.1

