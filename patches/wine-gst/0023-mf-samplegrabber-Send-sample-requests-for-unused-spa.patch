From 75184842e053297e41976b0eb8b56a73ba00a0aa Mon Sep 17 00:00:00 2001
From: Bones <babblebones@protnmail.com>
Date: Tue, 12 Aug 2025 13:39:19 -0400
Subject: [PATCH] mf/samplegrabber: Send sample requests for unused space of
 sample queue on pause => restart.

---
 dlls/mf/samplegrabber.c | 27 ++++++++++++++-------------
 1 file changed, 14 insertions(+), 13 deletions(-)

diff --git a/dlls/mf/samplegrabber.c b/dlls/mf/samplegrabber.c
index 4d54afc1d31..c63c3d3d610 100644
--- a/dlls/mf/samplegrabber.c
+++ b/dlls/mf/samplegrabber.c
@@ -91,6 +91,7 @@ struct sample_grabber
     CRITICAL_SECTION cs;
     UINT32 sample_count;
     IMFSample *samples[MAX_SAMPLE_QUEUE_LENGTH];
+    UINT32 samples_requested;
 };
 
 static IMFSampleGrabberSinkCallback *sample_grabber_get_callback(const struct sample_grabber *sink)
@@ -411,7 +412,8 @@ static HRESULT stream_queue_sample(struct sample_grabber *grabber, IMFSample *sa
 
 static void sample_grabber_stream_request_sample(struct sample_grabber *grabber)
 {
-    IMFStreamSink_QueueEvent(&grabber->IMFStreamSink_iface, MEStreamSinkRequestSample, &GUID_NULL, S_OK, NULL);
+    if (SUCCEEDED(IMFStreamSink_QueueEvent(&grabber->IMFStreamSink_iface, MEStreamSinkRequestSample, &GUID_NULL, S_OK, NULL)))
+        grabber->samples_requested++;
 }
 
 static HRESULT WINAPI sample_grabber_stream_ProcessSample(IMFStreamSink *iface, IMFSample *sample)
@@ -423,12 +425,13 @@ static HRESULT WINAPI sample_grabber_stream_ProcessSample(IMFStreamSink *iface,
 
     TRACE("%p, %p.\n", iface, sample);
 
-    if (!sample)
-        return S_OK;
-
     EnterCriticalSection(&grabber->cs);
 
-    if (grabber->is_shut_down)
+    grabber->samples_requested--;
+
+    if (!sample)
+        hr = S_OK;
+    else if (grabber->is_shut_down)
         hr = MF_E_STREAMSINK_REMOVED;
     else if (grabber->state == SINK_STATE_RUNNING || (grabber->state == SINK_STATE_PAUSED && grabber->ignore_clock))
     {
@@ -780,7 +783,7 @@ static HRESULT WINAPI sample_grabber_stream_timer_callback_Invoke(IMFAsyncCallba
             }
         }
     }
-    if (sample_delivered)
+    if (sample_delivered && grabber->samples_requested < MAX_SAMPLE_QUEUE_LENGTH)
         sample_grabber_stream_request_sample(grabber);
 
     LeaveCriticalSection(&grabber->cs);
@@ -1199,19 +1202,17 @@ static HRESULT sample_grabber_set_state(struct sample_grabber *grabber, enum sin
                 if (grabber->state == SINK_STATE_PAUSED && offset != PRESENTATION_CURRENT_POSITION)
                     grabber->sample_count = MAX_SAMPLE_QUEUE_LENGTH;
 
-                /* Every transition to running state sends a bunch requests to build up initial queue. */
-                for (i = 0; i < grabber->sample_count; ++i)
+                if (grabber->state == SINK_STATE_PAUSED && offset == PRESENTATION_CURRENT_POSITION)
                 {
-                    if (grabber->state == SINK_STATE_PAUSED && offset == PRESENTATION_CURRENT_POSITION)
+                    for (i = 0; i < grabber->sample_count; ++i)
                     {
                         assert(grabber->samples[i]);
                         stream_queue_sample(grabber, grabber->samples[i]);
                     }
-                    else
-                    {
-                        sample_grabber_stream_request_sample(grabber);
-                    }
                 }
+                /* Every transition to running state sends a bunch requests to build up initial queue. */
+                for (i = grabber->samples_requested; i < MAX_SAMPLE_QUEUE_LENGTH; ++i)
+                    sample_grabber_stream_request_sample(grabber);
                 release_samples(grabber);
                 grabber->sample_count = 0;
             }
-- 
2.50.1

