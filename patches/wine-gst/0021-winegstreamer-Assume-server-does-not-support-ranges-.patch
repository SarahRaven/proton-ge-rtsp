From 11f229ef98409ef2beb599e1e623a79e81caf49a Mon Sep 17 00:00:00 2001
From: Bones <babblebones@protnmail.com>
Date: Tue, 12 Aug 2025 13:27:32 -0400
Subject: [PATCH] winegstreamer: Assume server does not support ranges if
 response is missing Accept-Ranges header.

---
 dlls/winegstreamer/wg_parser.c | 80 ++++++++++++++++++++++++++++++++++
 1 file changed, 80 insertions(+)

diff --git a/dlls/winegstreamer/wg_parser.c b/dlls/winegstreamer/wg_parser.c
index 013571e5865..b889eda8741 100644
--- a/dlls/winegstreamer/wg_parser.c
+++ b/dlls/winegstreamer/wg_parser.c
@@ -110,6 +110,7 @@ struct wg_parser
     GstContext *context;
 
     bool is_seekable;
+    GstObject *force_source_not_seekable;
 };
 static const unsigned int input_cache_chunk_size = 512 << 10;
 
@@ -1653,6 +1654,37 @@ static gboolean src_activate_mode_cb(GstPad *pad, GstObject *parent, GstPadMode
     return FALSE;
 }
 
+static BOOL decodebin_parser_init_gst(struct wg_parser *parser);
+
+struct _GstSoupHTTPSrc_initial
+{
+    GstPushSrc element;
+    gchar *location;
+    gchar *redirection_uri;
+    gboolean redirection_permanent;
+    gchar *user_agent;
+    gboolean automatic_redirect;
+    void *proxy;
+    gchar *user_id;
+    gchar *user_pw;
+    gchar *proxy_id;
+    gchar *proxy_pw;
+    gchar **cookies;
+    void *session;
+    gboolean session_is_shared;
+    void *external_session;
+    void *msg;
+    gint retry_count;
+    gint max_retries;
+    gchar *method;
+    GstFlowReturn headers_ret;
+    gboolean got_headers;
+    gboolean have_size;
+    guint64 content_size;
+    guint64 read_position;
+    gboolean seekable;
+};
+
 static GstBusSyncReply bus_handler_cb(GstBus *bus, GstMessage *msg, gpointer user)
 {
     struct wg_parser *parser = user;
@@ -1694,6 +1726,15 @@ static GstBusSyncReply bus_handler_cb(GstBus *bus, GstMessage *msg, gpointer use
     case GST_MESSAGE_DURATION_CHANGED:
         pthread_mutex_lock(&parser->mutex);
         parser->has_duration = true;
+
+        /* HACK: Some decoding elements (e.g. qtdemux) send seek events
+           to the source is they believe it to be seekable. */
+        if (parser->force_source_not_seekable == GST_MESSAGE_SRC(msg))
+        {
+            struct _GstSoupHTTPSrc_initial *p = (void *)GST_MESSAGE_SRC(msg);
+            p->seekable = false;
+        }
+
         pthread_mutex_unlock(&parser->mutex);
         pthread_cond_signal(&parser->init_cond);
         break;
@@ -1715,6 +1756,44 @@ static GstBusSyncReply bus_handler_cb(GstBus *bus, GstMessage *msg, gpointer use
             }
             pthread_mutex_unlock(&parser->mutex);
         }
+        else if (gst_structure_has_name(structure, "http-headers"))
+        {
+            GstStructure *response_headers = NULL;
+
+            /* souphttpsrc assumes that servers that do not include an
+               Accept-Ranges header in the response do support ranges,
+               then breaks when seeking fails. Assume that servers that
+               do not include the Accept-Ranges header in the response
+               do not support seeking. */
+
+            gst_structure_get(structure, "response-headers", GST_TYPE_STRUCTURE, &response_headers, NULL);
+            if (response_headers)
+            {
+                bool found = false;
+                gint i;
+
+                for (i = 0; i < gst_structure_n_fields(response_headers); i++)
+                {
+                    const gchar *name = gst_structure_nth_field_name(response_headers, i);
+                    if (!strcasecmp(name, "Accept-Ranges") || !strcasecmp(name, "Content-Range"))
+                    {
+                        found = true;
+                        break;
+                    }
+                }
+                if (!found)
+                {
+                    struct _GstSoupHTTPSrc_initial *p = (void *)GST_MESSAGE_SRC(msg);
+
+                    GST_DEBUG("Forcing souphttpsrc not seekable.");
+                    p->seekable = false;
+                    pthread_mutex_lock(&parser->mutex);
+                    parser->is_seekable = false;
+                    parser->force_source_not_seekable = GST_MESSAGE_SRC(msg);
+                    pthread_mutex_unlock(&parser->mutex);
+                }
+            }
+        }
         break;
 
     case GST_MESSAGE_STREAM_STATUS:
@@ -1941,6 +2020,7 @@ static NTSTATUS wg_parser_connect(void *args)
     parser->next_pull_offset = 0;
     parser->error = false;
     parser->is_seekable = true;
+    parser->force_source_not_seekable = NULL;
 
     if (!parser->init_gst(parser))
         goto out;
-- 
2.50.1

