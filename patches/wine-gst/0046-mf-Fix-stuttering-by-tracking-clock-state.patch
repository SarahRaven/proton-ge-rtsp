From cf94640016a9de6c8d0da4181334a7f061d26d68 Mon Sep 17 00:00:00 2001
From: Bones <babblebones@protnmail.com>
Date: Tue, 12 Aug 2025 14:56:03 -0400
Subject: [PATCH] mf: Fix stuttering by tracking clock state.

---
 dlls/mf/session.c | 29 +++++++++++++++++++++++++----
 1 file changed, 25 insertions(+), 4 deletions(-)

diff --git a/dlls/mf/session.c b/dlls/mf/session.c
index cb3628fc5e1..fce94a8e389 100644
--- a/dlls/mf/session.c
+++ b/dlls/mf/session.c
@@ -280,6 +280,7 @@ struct media_session
     enum session_state state;
     DWORD caps;
     BOOL buffering;
+    BOOL clock_started;
     CRITICAL_SECTION cs;
 };
 
@@ -1543,8 +1544,11 @@ static void session_stop(struct media_session *session)
                 session_set_state(session, SESSION_STATE_STOPPING_SINKS);
                 session_stop_sources(session);
             }
-            else if (SUCCEEDED(hr = IMFPresentationClock_Stop(session->clock)))
+            if (SUCCEEDED(hr = IMFPresentationClock_Stop(session->clock)))
+            {
+                session->clock_started = FALSE;
                 session_set_state(session, SESSION_STATE_STOPPING_SINKS);
+            }
             else
                 session_set_stopped(session, hr);
 
@@ -1606,8 +1610,11 @@ static void session_close(struct media_session *session)
                 session_set_state(session, SESSION_STATE_STOPPING_SINKS);
                 session_stop_sources(session);
             }
-            else if (SUCCEEDED(hr = IMFPresentationClock_Stop(session->clock)))
+            if (SUCCEEDED(hr = IMFPresentationClock_Stop(session->clock)))
+            {
+                session->clock_started = FALSE;
                 session_set_state(session, SESSION_STATE_STOPPING_SINKS);
+            }
             break;
         default:
             hr = MF_E_INVALIDREQUEST;
@@ -3481,6 +3488,7 @@ static enum object_state session_get_object_state_for_event(MediaEventType event
 static HRESULT session_start_clock(struct media_session *session)
 {
     LONGLONG start_offset = 0;
+    MFCLOCK_STATE state;
     HRESULT hr;
 
     if (IsEqualGUID(&session->presentation.time_format, &GUID_NULL))
@@ -3495,10 +3503,23 @@ static HRESULT session_start_clock(struct media_session *session)
     else
         FIXME("Unhandled time format %s.\n", debugstr_guid(&session->presentation.time_format));
 
+    if (start_offset == PRESENTATION_CURRENT_POSITION && !session->clock_started)
+    {
+        if (SUCCEEDED(IMFPresentationClock_GetState(session->clock, 0, &state)) &&
+                state != MFCLOCK_STATE_INVALID && state != MFCLOCK_STATE_STOPPED &&
+                SUCCEEDED(IMFPresentationClock_Stop(session->clock)))
+            session->clock_started = FALSE;
+        start_offset = 0;
+    }
+
     if (FAILED(hr = IMFPresentationClock_Start(session->clock, start_offset)))
         WARN("Failed to start session clock, hr %#lx.\n", hr);
-    else if (session->buffering)
-        IMFPresentationClock_Pause(session->clock);
+    else
+    {
+        session->clock_started = TRUE;
+        if (session->buffering)
+            IMFPresentationClock_Pause(session->clock);
+    }
 
     return hr;
 }
-- 
2.50.1

